require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
require 'xcodeproj'

platform :ios, '14.0'
use_frameworks!

# workaround to avoid Xcode caching of Pods that requires
# Product -> Clean Build Folder after new Cordova plugins installed
# Requires CocoaPods 1.6 or newer
install! 'cocoapods', :disable_input_output_paths => true

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  # Removed: BrandonknudsenAdmobNativeAdvanced (requires Xcode 15.1+)
  pod 'CapacitorCommunityAdmob', :path => '../../node_modules/@capacitor-community/admob'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorCommunityHttp', :path => '../../node_modules/@capacitor-community/http'
  pod 'CapacitorFirebaseMessaging', :path => '../../node_modules/@capacitor-firebase/messaging'
  pod 'CapacitorApp', :path => '../../node_modules/@capacitor/app'
  pod 'CapacitorBrowser', :path => '../../node_modules/@capacitor/browser'
  pod 'CapacitorDevice', :path => '../../node_modules/@capacitor/device'
  pod 'CapacitorDialog', :path => '../../node_modules/@capacitor/dialog'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorGeolocation', :path => '../../node_modules/@capacitor/geolocation'
  pod 'CapacitorHaptics', :path => '../../node_modules/@capacitor/haptics'
  pod 'CapacitorLocalNotifications', :path => '../../node_modules/@capacitor/local-notifications'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorStatusBar', :path => '../../node_modules/@capacitor/status-bar'
  pod 'CodetrixStudioCapacitorGoogleAuth', :path => '../../node_modules/@codetrix-studio/capacitor-google-auth'
  pod 'TeamLepisodeCapacitorNaverLogin', :path => '../../node_modules/@team-lepisode/capacitor-naver-login'
  pod 'TransistorsoftCapacitorBackgroundFetch', :path => '../../node_modules/@transistorsoft/capacitor-background-fetch'
  pod 'CapacitorKakaoLoginPlugin', :path => '../../node_modules/capacitor-kakao-login-plugin'
  pod 'CapacitorPluginAppTrackingTransparency', :path => '../../node_modules/capacitor-plugin-app-tracking-transparency'
end

target 'App' do
  capacitor_pods
  # Add your Pods here

  pod 'Firebase/Crashlytics', '10.29.0'
  pod 'Firebase/Analytics', '10.29.0'
  pod 'Firebase/Messaging', '10.29.0'
  pod 'Firebase/Core', '10.29.0'
  pod 'Alamofire', '5.6.4' # Pin for Xcode 14.2 compatibility
end

post_install do |installer|
  assertDeploymentTarget(installer)
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
      config.build_settings['CODE_SIGN_IDENTITY'] = 'iPhone Developer'
      config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
      
      # Fix for FBLPromises_Privacy: Only apply Swift hacks to non-bundle targets
      if target.respond_to?(:product_type) && target.product_type == "com.apple.product-type.bundle"
        # Skip aggressive Swift settings for bundles
      else
        config.build_settings['ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES'] = 'YES'
        config.build_settings['LIBRARY_SEARCH_PATHS'] = ['$(SDKROOT)/usr/lib/swift', '$(TOOLCHAIN_DIR)/usr/lib/swift/$(PLATFORM_NAME)', '$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)', '$(inherited)']
        config.build_settings['OTHER_LDFLAGS'] = '$(inherited) -Wl,-U,___swift_FORCE_LOAD_$_swiftCompatibility56 -Wl,-U,___swift_FORCE_LOAD_$_swiftCompatibility55'
      end
    end
  end

  # 2. Fix MAIN APP Target (Inject Linker Flags into App.xcodeproj)
  # The error happens in "Link App", so we must patch the App target itself, not just Pods.
  project_path = 'App.xcodeproj'
  project = Xcodeproj::Project.open(project_path)
  project.targets.each do |target|
    if target.name == 'App'
      puts "ðŸŽ¯ Patching Main App Target: #{target.name}"
      target.build_configurations.each do |config|
        # Ensure OTHER_LDFLAGS is an array
        ld_flags = config.build_settings['OTHER_LDFLAGS'] || ['$(inherited)']
        ld_flags = [ld_flags] if ld_flags.is_a?(String)
        
        # Inject flags if not present
        # Brute Force Underscore Variants because Xcode/Arch can vary (1, 2, 3, or 4 underscores)
        symbols = [
           'swift_FORCE_LOAD_$_swiftCompatibility56',
           'swift_FORCE_LOAD_$_swiftCompatibility55',
           'swift_FORCE_LOAD_$_swiftCompatibilityConcurrency',
           # Add MarketplaceKit symbols for AdMob SDK 12.12.0+
           's14MarketplaceKit14AppDistributorO10testFlightyA2CmFWC',
           's14MarketplaceKit14AppDistributorO11marketplaceyACSSACmFWC',
           's14MarketplaceKit14AppDistributorO3webyA2CmFWC',
           's14MarketplaceKit14AppDistributorO5otheryA2CmFWC',
           's14MarketplaceKit14AppDistributorO7currentACvgZ',
           's14MarketplaceKit14AppDistributorO7currentACvgZTu',
           's14MarketplaceKit14AppDistributorO8appStoreyA2CmFWC',
           's14MarketplaceKit14AppDistributorOMa',
           's14MarketplaceKit14AppDistributorOMn',
           'swift_FORCE_LOAD_$_swiftXPC',
           'swift_FORCE_LOAD_$_swift_Builtin_float',
           'swift_FORCE_LOAD_$_swift_errno',
           'swift_FORCE_LOAD_$_swift_math',
           'swift_FORCE_LOAD_$_swift_signal',
           'swift_FORCE_LOAD_$_swift_stdio',
           'swift_FORCE_LOAD_$_swift_time',
           'swift_FORCE_LOAD_$_swiftsys_time',
           'swift_FORCE_LOAD_$_swiftunistd'
        ]
        
        prefixes = ['_', '__', '___', '____']
        
        symbols.each do |sym|
           prefixes.each do |p|
              full_sym = p + sym
              flag = "-Wl,-U,#{full_sym}"
              unless ld_flags.include?(flag)
                 ld_flags << flag
                 puts "   -> Injected undefined flag: #{flag}"
              end
           end
        end
        
        config.build_settings['OTHER_LDFLAGS'] = ld_flags

        # Inject LIBRARY_SEARCH_PATHS
        search_paths = config.build_settings['LIBRARY_SEARCH_PATHS'] || ['$(inherited)']
        search_paths = [search_paths] if search_paths.is_a?(String)
        
        new_paths = [
          '$(SDKROOT)/usr/lib/swift',
          '$(TOOLCHAIN_DIR)/usr/lib/swift/$(PLATFORM_NAME)',
          '$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)'
        ]
        
        new_paths.each do |path|
          unless search_paths.include?(path)
            search_paths << path
            puts "   -> Injected #{path} to LIBRARY_SEARCH_PATHS for #{config.name}"
          end
        end
        
        config.build_settings['LIBRARY_SEARCH_PATHS'] = search_paths
      end
    end
  end
  project.save
end
